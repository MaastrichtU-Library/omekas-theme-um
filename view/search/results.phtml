<?php
/**
 * @var \Laminas\View\Renderer\PhpRenderer $this
 * @var \Omeka\Api\Representation\SiteRepresentation|null $site
 * @var \AdvancedSearch\Api\Representation\SearchConfigRepresentation $searchConfig
 * @var \AdvancedSearch\Query $query
 * @var \AdvancedSearch\Response $response
 * @var ?string $resourceType The resource type may be "resources" or a specific one.
 * @var \Omeka\Api\Representation\ItemSetRepresentation|null $itemSet
 */

// A check is done: when page is not first, the resources may be empty even with results.
$resources = $response->getResources($resourceType);
if (!$resources) return;

$plugins = $this->getHelperPluginManager();
$assetUrl = $plugins->get('assetUrl');
$translate = $plugins->get('translate');
$hyperlink = $plugins->get('hyperlink');
$thumbnail = $plugins->get('thumbnail');
$escapeValueOrGetHtml = $plugins->get('escapeValueOrGetHtml');

$selectionButton = $site && $plugins->has('selectionButton') && $this->siteSetting('selection_append_items_browse_individual') ? $plugins->get('selectionButton') : null;
$contactUsSelector = $site && $plugins->has('contactUsSelector') && $this->siteSetting('contactus_append_items_browse_individual') ? $plugins->get('contactUsSelector') : null;

// Can be simplified in a public theme.
$setting = $plugins->get(isset($site) ? 'siteSetting' : 'setting');

$siteSlug = isset($site) ? $site->slug() : null;

$filterLocale = (bool) $setting('filter_locale_values');
$lang = $plugins->get('lang')();
$langValue = $filterLocale ? [$lang, ''] : null;

$untitled = $translate('[Untitled]');

$headingTerm = $setting('browse_heading_property_term');
$bodyTerm = $setting('browse_body_property_term');

$gridListMode = $searchConfig->subSetting('results', 'grid_list_mode', 'auto');

// A list does not have html-code in a consistant user interface.
$allowHtml = (bool) $searchConfig->subSetting('results', 'allow_html');

$thumbnailMode = $searchConfig->subSetting('results', 'thumbnail_mode', 'default');
$noThumbnail = $thumbnailMode === 'none';
$allThumbnail = $thumbnailMode === 'all';
$defaultThumbnail = $allThumbnail
    ? sprintf('<img loading="lazy" src="%1$s" title="%2$s"/>', $assetUrl('thumbnails/default.png', 'Omeka', true), $translate('No media'))
    : '';

$thumbnailType = $searchConfig->subSetting('results', 'thumbnail_type', 'medium');
$customFieldList=str_replace(' ','',$this->themeSetting('CustomFieldList'));
$tagTermList=explode(",", $customFieldList);






?>

<ul class="resource-list search-results-list<?= $gridListMode === 'list_only' ? ' list' : ($gridListMode === 'grid_only' ? ' grid' : '') ?>">
    <?php /** @var \Omeka\Api\Representation\AbstractResourceEntityRepresentation $resource */
    foreach ($resources as $resource):
        $resourceUrl = isset($site) ? $resource->siteUrl($siteSlug) : $resource->adminUrl();
        $resourceType = $resource->getControllerName();
        $heading = $headingTerm ? $resource->value($headingTerm, ['default' => $untitled, 'lang' => $langValue]) : $resource->displayTitle($untitled, $langValue);
        
        	
        
		# PV 15-6-2022: Order changed. Removed unused values;
		//$tagTerms = ['modsrdf:name', 'modsrdf:subject',  'schema:dateIssued', 'schema:contributor', 'modsrdf:namePrincipal'];
        $tagTerms = $tagTermList;
        $showLabel = true;
        $vals = $resource->values();
        $template = $resource->resourceTemplate();
      

        $tagHtml = '';
		$searchEngine=$this->themeSetting('searchController') ;
				
        foreach ($tagTerms as $tagTerm) {
            if(isset($vals[$tagTerm])) {
                $tagLabel="";
                $fields = $vals[$tagTerm]['values'];

                //PV 2023-11-05: This piece of code gets the resource template fot the current field.
                $templateProperty = $template ? $template->resourceTemplateProperty($fields[0]->property()->id()) : null;
                $altLabel = $templateProperty ? $templateProperty->alternateLabel() : null;


                if(($fields!=null)&&(count($fields))) {
                    $tagHtml .= '<div class="tag-group ' . str_replace(':', '\:', $tagTerm) . '">';

                    if($showLabel) {
                        $label = $fields[0]->property()->label();
                        $label = $altLabel?$altLabel:$label;
                        $tagLabel=$label;
                        $tagHtml .= '<span class="tag-label">'.$tagLabel.'</span>:&nbsp;';
                    }

                    foreach ($fields as $val) {
                        try {
							$test='';
                            $f_id = $val->property()->id();
							$f_pid = $val->property()->label();
							$f_pid2= $val->property()->localName();
							$tt2=str_replace(':', '_', $tagTerm);
							if($val)
							{
								if($tagTerm == "modsrdf:name" && $val->valueResource()) {    // The displayName for modsrdf:name is in the class method '$val->valueResource()->title()'. We need to test if it exists first.
									// Query to make the field browsable with a link
									$query = ['query' => [$searchEngine => '','property[0][property]' => $f_id, 'property[0][type]' => 'eq', 'property[0][text]' => strval($val->valueResource()->title())]];
									//$tagHtml .= $this->hyperlink(strval($val->valueResource()->title()), $this->url('site/resource', ['controller' => 'find', 'action' => 'find'], $query, true), ['class' => 'tag'])." ";
									$tagHtml .= $this->hyperlink(strval($val->valueResource()->title()), $this->url('site/resource',['controller' => 'item', 'action' => 'browse'] , $query, true), ['class' => 'tag'])." ";
									
									
								} else {    // The displayName for all other tagTerms is in the default class method for value (= root of $val)
									// Query to make the field browsable with a link
									$query = ['query' => [$searchEngine => '', 'property[0][property]' => $f_id, 'property[0][type]' => 'eq', 'property[0][text]' => strval($val)]];
									$tagHtml .= $this->hyperlink(strval($val), $this->url('site/resource', ['controller' => 'item', 'action' => 'browse'], $query, true), ['class' => 'tag'])." ";
								}
							}
                        } catch (\Throwable $th) {
                            echo $th;
                        }
                    }
					
					$tagHtml .= '</div>';
                    
					//$tagHtml .= '<div class="info">Property: '. $f_pid.' Property local name: '.$f_pid2.' Property local name: '.$tt2.'</div> ';
                }
            }
        }
        $body = $bodyTerm ? $resource->value($bodyTerm, ['lang' => $langValue, 'default' => '']) : $resource->displayDescription(null, $langValue);
        
        
        
        ?>
    <li class="resource <?= $resourceType ?>">
         <?php if (!$noThumbnail): ?>
        <?php $resourceThumbnail = $thumbnail($resource, $thumbnailType); ?>
        <div class="resource-thumbnail<?= $resourceThumbnail ? '' : ($allThumbnail ? ' default-thumbnail' : '') ?>">
            <?php if ($resourceThumbnail || $allThumbnail): ?>
            <?= $hyperlink->raw($resourceThumbnail ?: $defaultThumbnail, $resourceUrl, ['class' => 'resource-link']) ?>
            <?php endif; ?>
        </div>
        <?php endif; ?>
        <div class="item-meta">
        <div class="resource-heading">
            <?= $hyperlink->raw($escapeValueOrGetHtml($heading), $resourceUrl, ['class' => 'resource-link']) ?>
        </div>
       
        <div class="resource-body resource-metadata">
            <?php if (strlen($body)): ?>
            <div class="description">
                <?= $escapeValueOrGetHtml($body, $allowHtml) ?>
                <?= $tagHtml ?>
             
            </div>
            <?php endif; ?>
        </div>
        </div>
        <?php if ($selectionButton): ?>
        <?= $selectionButton($resource) ?>
        <?php endif; ?>
        <?php if ($contactUsSelector): ?>
        <?= $contactUsSelector($resource) ?>
        <?php endif; ?>
    </li>
    <?php endforeach; ?>
</ul>
